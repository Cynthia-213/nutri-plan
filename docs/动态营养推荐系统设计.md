# 基于BMR和目标的动态营养推荐系统设计文档

## 目录
1. [整体系统架构](#整体系统架构)
2. [BMR和TDEE计算](#bmr和tdee计算)
3. [热量区间设计](#热量区间设计)
4. [宏量营养素分配逻辑](#宏量营养素分配逻辑)
5. [动态调整机制](#动态调整机制)
6. [人群差异化策略](#人群差异化策略)
7. [科学依据](#科学依据)
8. [实现方案](#实现方案)

---

## 整体系统架构

### 1.1 系统层次结构

```
用户数据层 (User Profile)
    ↓
计算引擎层 (Calculation Engine)
    ├── BMR/TDEE计算器 (已实现)
    ├── 热量区间计算器 (需新增)
    ├── 宏量营养素分配器 (需重构)
    └── 动态调整引擎 (需新增)
    ↓
推荐服务层 (Recommendation Service)
    ├── 基础推荐服务 (需重构)
    ├── 动态调整服务 (需新增)
    └── 个性化策略服务 (需新增)
    ↓
数据持久层 (Data Persistence)
    ├── 用户基础数据 (已实现)
    ├── 体重历史记录 (需新增)
    ├── 体脂率记录 (需新增)
    └── 推荐历史记录 (需新增)
```

### 1.2 核心组件说明

- **BMR/TDEE计算器**: 基于Mifflin-St Jeor公式，已实现
- **热量区间计算器**: 根据目标生成热量范围而非单一值
- **宏量营养素分配器**: 基于科学共识的动态分配逻辑
- **动态调整引擎**: 基于历史数据自动调整推荐
- **个性化策略服务**: 处理不同人群的差异化需求

---

## BMR和TDEE计算

### 2.1 当前实现状态

✅ **已实现** (`backend/app/services/calorie_calculator.py`)

- **BMR计算**: 使用Mifflin-St Jeor公式
  - 公式: `BMR = 10 × 体重(kg) + 6.25 × 身高(cm) - 5 × 年龄(岁) + 性别常数`
  - 性别常数: 男性 +5, 女性 -161
- **TDEE计算**: `TDEE = BMR × 活动水平系数`
  - 活动水平系数:
    - 久坐 (sedentary): 1.2
    - 轻度活跃 (lightly_active): 1.375
    - 中度活跃 (moderately_active): 1.55
    - 非常活跃 (very_active): 1.725
    - 极度活跃 (extra_active): 1.9

### 2.2 科学依据

- **Mifflin-St Jeor公式**: 目前最准确的BMR估算公式之一，误差约±10%
- **活动水平系数**: 基于Harris-Benedict修正系数，广泛用于运动营养学

### 2.3 优化建议

- 考虑添加Katch-McArdle公式作为备选（需要体脂率数据）
- 对于高体脂人群，可考虑使用去脂体重(FFM)计算

---

## 热量区间设计

### 3.1 设计理念

**从单一值到区间范围**：提供热量范围而非固定值，允许用户根据实际情况灵活调整。

### 3.2 不同目标的热量区间计算

#### 3.2.1 减脂 (lose_weight)

**科学依据**: 
- 安全减脂速度: 每周0.5-1kg体重下降
- 热量赤字: 每周3500-7000 kcal ≈ 每天500-1000 kcal
- 建议赤字: 10-25% TDEE

**区间计算**:
```
最低热量 = TDEE × 0.75  (25%赤字，激进减脂)
推荐热量 = TDEE × 0.85  (15%赤字，温和减脂)
最高热量 = TDEE × 0.90  (10%赤字，保守减脂)

特殊情况:
- 高体脂人群(体脂率>30%): 可接受30%赤字
- 低体脂人群(体脂率<15%): 建议不超过20%赤字
```

#### 3.2.2 增肌 (gain_muscle)

**科学依据**:
- 自然增肌速度: 每月0.5-1kg肌肉（新手）或0.25-0.5kg（有经验）
- 热量盈余: 每周约2000-3500 kcal ≈ 每天300-500 kcal
- 建议盈余: 5-15% TDEE

**区间计算**:
```
最低热量 = TDEE × 1.05  (5%盈余，保守增肌)
推荐热量 = TDEE × 1.10  (10%盈余，标准增肌)
最高热量 = TDEE × 1.15  (15%盈余，激进增肌)

特殊情况:
- 初学者: 可接受更高盈余(15-20%)
- 有经验训练者: 建议5-10%盈余，避免过多脂肪增长
```

#### 3.2.3 增重 (gain_weight)

**科学依据**:
- 适用于低体重人群(BMI<18.5)
- 热量盈余: 每天300-500 kcal
- 建议盈余: 10-20% TDEE

**区间计算**:
```
最低热量 = TDEE × 1.10  (10%盈余)
推荐热量 = TDEE × 1.15  (15%盈余)
最高热量 = TDEE × 1.20  (20%盈余)
```

#### 3.2.4 体态重组 (body_recomposition)

**科学依据**:
- 同时减脂增肌，适用于体脂率15-25%的中等体脂人群
- 热量策略: 接近维持热量，或轻微赤字(5-10%)
- 需要高蛋白摄入和规律力量训练

**区间计算**:
```
最低热量 = TDEE × 0.95  (5%赤字)
推荐热量 = TDEE × 1.00  (维持热量)
最高热量 = TDEE × 1.05  (5%盈余)

关键: 体态重组需要精确的宏量营养素分配和训练配合
```

#### 3.2.5 维持 (maintain)

**区间计算**:
```
最低热量 = TDEE × 0.95  (允许5%波动)
推荐热量 = TDEE × 1.00  (维持热量)
最高热量 = TDEE × 1.05  (允许5%波动)
```

### 3.3 实现示例

```python
def calculate_calorie_range(user: User, tdee: float) -> dict:
    """
    计算热量区间
    返回: {
        'min_kcal': 最低热量,
        'recommended_kcal': 推荐热量,
        'max_kcal': 最高热量,
        'range_description': '区间说明'
    }
    """
    goal = user.goal
    body_fat_pct = get_user_body_fat(user)  # 需要新增体脂率字段
    
    if goal == 'lose_weight':
        # 根据体脂率调整赤字幅度
        if body_fat_pct and body_fat_pct > 30:
            deficit_pct = 0.25  # 高体脂可接受更大赤字
        elif body_fat_pct and body_fat_pct < 15:
            deficit_pct = 0.15  # 低体脂保守减脂
        else:
            deficit_pct = 0.20  # 标准赤字
        
        return {
            'min_kcal': round(tdee * (1 - deficit_pct * 1.2), 0),
            'recommended_kcal': round(tdee * (1 - deficit_pct), 0),
            'max_kcal': round(tdee * (1 - deficit_pct * 0.8), 0),
            'range_description': f'减脂区间: {deficit_pct*100:.0f}%热量赤字'
        }
    
    elif goal == 'gain_muscle':
        # 根据训练经验调整盈余
        training_experience = get_training_experience(user)  # 需要新增字段
        if training_experience == 'beginner':
            surplus_pct = 0.15
        else:
            surplus_pct = 0.10
        
        return {
            'min_kcal': round(tdee * (1 + surplus_pct * 0.5), 0),
            'recommended_kcal': round(tdee * (1 + surplus_pct), 0),
            'max_kcal': round(tdee * (1 + surplus_pct * 1.5), 0),
            'range_description': f'增肌区间: {surplus_pct*100:.0f}%热量盈余'
        }
    
    # ... 其他目标类似
```

---

## 宏量营养素分配逻辑

### 4.1 分配原则

**优先级顺序**:
1. **蛋白质**: 基于体重和目标，固定g/kg体重
2. **脂肪**: 基于总热量百分比，保证必需脂肪酸
3. **碳水化合物**: 剩余热量分配给碳水

### 4.2 不同目标的宏量营养素分配

#### 4.2.1 蛋白质 (Protein)

**科学依据**:
- 维持: 0.8-1.0 g/kg体重
- 增肌: 1.6-2.2 g/kg体重 (推荐1.8-2.0 g/kg)
- 减脂: 1.6-2.2 g/kg体重 (高蛋白有助于保持肌肉)
- 体态重组: 2.0-2.4 g/kg体重 (最高需求)

**分配逻辑**:
```python
def calculate_protein_requirement(user: User, goal: str) -> dict:
    """
    计算蛋白质需求
    返回: {
        'min_g': 最低克数,
        'recommended_g': 推荐克数,
        'max_g': 最高克数,
        'g_per_kg': 每公斤体重克数
    }
    """
    weight_kg = float(user.weight_kg)
    
    if goal == 'maintain':
        g_per_kg = {'min': 0.8, 'recommended': 0.9, 'max': 1.0}
    elif goal == 'lose_weight':
        g_per_kg = {'min': 1.6, 'recommended': 1.8, 'max': 2.2}
    elif goal == 'gain_muscle':
        g_per_kg = {'min': 1.6, 'recommended': 1.8, 'max': 2.2}
    elif goal == 'body_recomposition':
        g_per_kg = {'min': 2.0, 'recommended': 2.2, 'max': 2.4}
    else:  # gain_weight
        g_per_kg = {'min': 1.2, 'recommended': 1.4, 'max': 1.6}
    
    return {
        'min_g': round(weight_kg * g_per_kg['min'], 1),
        'recommended_g': round(weight_kg * g_per_kg['recommended'], 1),
        'max_g': round(weight_kg * g_per_kg['max'], 1),
        'g_per_kg': g_per_kg['recommended']
    }
```

#### 4.2.2 脂肪 (Fat)

**科学依据**:
- 最低需求: 总热量的15-20% (保证必需脂肪酸)
- 推荐范围: 20-35%总热量
- 减脂期: 可适当提高至25-30% (增加饱腹感)
- 增肌期: 20-25% (为碳水留出空间)

**分配逻辑**:
```python
def calculate_fat_requirement(total_kcal: float, goal: str) -> dict:
    """
    计算脂肪需求
    返回: {
        'min_g': 最低克数,
        'recommended_g': 推荐克数,
        'max_g': 最高克数,
        'percentage': 占总热量百分比
    }
    """
    if goal == 'lose_weight':
        fat_pct = {'min': 0.25, 'recommended': 0.28, 'max': 0.30}
    elif goal == 'gain_muscle':
        fat_pct = {'min': 0.20, 'recommended': 0.23, 'max': 0.25}
    elif goal == 'body_recomposition':
        fat_pct = {'min': 0.22, 'recommended': 0.25, 'max': 0.28}
    else:  # maintain, gain_weight
        fat_pct = {'min': 0.25, 'recommended': 0.30, 'max': 0.35}
    
    recommended_kcal = total_kcal * fat_pct['recommended']
    recommended_g = recommended_kcal / 9  # 1g脂肪=9kcal
    
    return {
        'min_g': round(total_kcal * fat_pct['min'] / 9, 1),
        'recommended_g': round(recommended_g, 1),
        'max_g': round(total_kcal * fat_pct['max'] / 9, 1),
        'percentage': fat_pct['recommended']
    }
```

#### 4.2.3 碳水化合物 (Carbohydrates)

**科学依据**:
- 剩余热量原则: 总热量 - 蛋白质热量 - 脂肪热量
- 训练日: 可适当提高碳水摄入
- 休息日: 可适当降低碳水摄入

**分配逻辑**:
```python
def calculate_carb_requirement(
    total_kcal: float, 
    protein_g: float, 
    fat_g: float
) -> dict:
    """
    计算碳水化合物需求（剩余热量原则）
    """
    protein_kcal = protein_g * 4
    fat_kcal = fat_g * 9
    carb_kcal = total_kcal - protein_kcal - fat_kcal
    carb_g = carb_kcal / 4  # 1g碳水=4kcal
    
    return {
        'recommended_g': round(carb_g, 1),
        'percentage': round(carb_kcal / total_kcal * 100, 1)
    }
```

### 4.3 人群差异化处理

#### 4.3.1 高体脂人群 (体脂率>30%)

**特点**: 代谢灵活性较差，胰岛素敏感性可能较低

**调整策略**:
- 蛋白质: 1.8-2.0 g/kg (略高于标准)
- 脂肪: 25-30% (增加饱腹感)
- 碳水: 适度降低，优先选择低GI食物

#### 4.3.2 初学者 vs 有经验训练者

**初学者**:
- 蛋白质: 1.6-1.8 g/kg (新手增肌效果明显，可略低)
- 热量盈余: 可接受更高盈余(15-20%)

**有经验训练者**:
- 蛋白质: 1.8-2.2 g/kg (需要更高蛋白维持)
- 热量盈余: 建议5-10% (避免过多脂肪增长)

#### 4.3.3 女性特殊考虑

**科学依据**:
- 女性在减脂期更容易流失肌肉
- 月经周期影响代谢和食欲

**调整策略**:
- 减脂期蛋白质: 建议1.8-2.0 g/kg (高于男性标准)
- 脂肪摄入: 不低于25% (对激素平衡重要)
- 可考虑周期化营养策略（月经周期不同阶段微调）

---

## 动态调整机制

### 5.1 触发调整的数据指标

#### 5.1.1 体重变化

**监测周期**: 每周测量，计算4周平均趋势

**调整规则**:
```python
def should_adjust_by_weight(user: User, weight_history: list) -> dict:
    """
    基于体重变化判断是否需要调整
    weight_history: [(date, weight), ...] 最近4-8周数据
    """
    if len(weight_history) < 4:
        return {'adjust': False, 'reason': '数据不足'}
    
    # 计算周平均体重变化
    recent_weeks = weight_history[-4:]
    weight_change_per_week = (recent_weeks[-1][1] - recent_weeks[0][1]) / 4
    
    goal = user.goal
    
    if goal == 'lose_weight':
        # 减脂目标: 期望每周下降0.5-1kg
        if weight_change_per_week > -0.3:  # 下降太慢
            return {
                'adjust': True,
                'action': 'decrease_calories',
                'adjustment_kcal': -100 to -200,
                'reason': f'体重下降速度过慢({weight_change_per_week:.2f}kg/周)'
            }
        elif weight_change_per_week < -1.2:  # 下降太快
            return {
                'adjust': True,
                'action': 'increase_calories',
                'adjustment_kcal': +100 to +200,
                'reason': f'体重下降速度过快，可能影响代谢({weight_change_per_week:.2f}kg/周)'
            }
    
    elif goal == 'gain_muscle':
        # 增肌目标: 期望每周增长0.1-0.3kg
        if weight_change_per_week < 0.05:  # 增长太慢
            return {
                'adjust': True,
                'action': 'increase_calories',
                'adjustment_kcal': +100 to +200,
                'reason': f'体重增长过慢({weight_change_per_week:.2f}kg/周)'
            }
        elif weight_change_per_week > 0.5:  # 增长太快（可能是脂肪）
            return {
                'adjust': True,
                'action': 'decrease_calories',
                'adjustment_kcal': -100 to -150,
                'reason': f'体重增长过快，可能脂肪增长过多({weight_change_per_week:.2f}kg/周)'
            }
    
    return {'adjust': False, 'reason': '体重变化在合理范围内'}
```

#### 5.1.2 体脂率变化

**监测周期**: 每2-4周测量（需要新增体脂率记录功能）

**调整规则**:
- 减脂期: 如果体重下降但体脂率不变，可能流失肌肉 → 增加蛋白质
- 增肌期: 如果体重增长但体脂率上升过快 → 减少热量盈余

#### 5.1.3 训练表现

**监测指标**:
- 力量训练: 重量/次数是否提升
- 有氧训练: 耐力/速度是否改善

**调整规则**:
```python
def should_adjust_by_performance(
    user: User, 
    exercise_logs: list,
    goal: str
) -> dict:
    """
    基于训练表现判断
    """
    if goal == 'gain_muscle':
        # 如果力量训练表现下降，可能是热量不足
        strength_trend = analyze_strength_trend(exercise_logs)
        if strength_trend == 'declining':
            return {
                'adjust': True,
                'action': 'increase_calories',
                'adjustment_kcal': +100 to +150,
                'reason': '训练表现下降，可能热量不足'
            }
```

#### 5.1.4 实际摄入vs推荐摄入

**监测周期**: 每日监测，每周评估

**调整规则**:
```python
def should_adjust_by_compliance(
    user: User,
    daily_logs: list  # 最近7-14天日志
) -> dict:
    """
    基于用户实际执行情况调整
    """
    avg_actual_kcal = calculate_avg_intake(daily_logs)
    recommended_kcal = get_current_recommendation(user).recommended_kcal
    
    compliance_rate = avg_actual_kcal / recommended_kcal
    
    if compliance_rate < 0.8:  # 持续低于推荐值20%以上
        # 用户可能觉得推荐值过高，适当降低
        return {
            'adjust': True,
            'action': 'decrease_calories',
            'adjustment_kcal': -50 to -100,
            'reason': '实际摄入持续低于推荐，调整至更易执行的水平'
        }
    elif compliance_rate > 1.2:  # 持续高于推荐值20%以上
        # 用户可能觉得推荐值过低，适当提高
        return {
            'adjust': True,
            'action': 'increase_calories',
            'adjustment_kcal': +50 to +100,
            'reason': '实际摄入持续高于推荐，调整至更符合实际需求'
        }
```

### 5.2 自动调整算法

#### 5.2.1 调整频率

- **快速调整**: 每周评估，每月最多调整1次
- **保守调整**: 每次调整幅度不超过±200 kcal
- **渐进调整**: 连续调整需要间隔至少2周

#### 5.2.2 调整优先级

1. **安全性优先**: 确保不低于BMR的1.1倍（避免代谢下降）
2. **目标一致性**: 调整后仍符合用户目标方向
3. **可持续性**: 考虑用户执行能力

#### 5.2.3 实现示例

```python
class DynamicAdjustmentEngine:
    """
    动态调整引擎
    """
    
    def evaluate_and_adjust(
        self, 
        user: User, 
        db: Session,
        current_recommendation: CalorieRecommendation
    ) -> CalorieRecommendation:
        """
        评估当前推荐并决定是否调整
        """
        # 1. 收集历史数据
        weight_history = self.get_weight_history(db, user.id, weeks=8)
        body_fat_history = self.get_body_fat_history(db, user.id, weeks=8)
        daily_logs = self.get_daily_logs(db, user.id, days=14)
        exercise_logs = self.get_exercise_logs(db, user.id, weeks=4)
        
        # 2. 多维度评估
        adjustments = []
        
        # 体重变化评估
        weight_adjustment = should_adjust_by_weight(user, weight_history)
        if weight_adjustment['adjust']:
            adjustments.append(weight_adjustment)
        
        # 体脂率评估
        if body_fat_history:
            bf_adjustment = should_adjust_by_body_fat(user, body_fat_history)
            if bf_adjustment['adjust']:
                adjustments.append(bf_adjustment)
        
        # 执行情况评估
        compliance_adjustment = should_adjust_by_compliance(user, daily_logs)
        if compliance_adjustment['adjust']:
            adjustments.append(compliance_adjustment)
        
        # 3. 综合决策
        if not adjustments:
            return current_recommendation  # 无需调整
        
        # 计算综合调整量（取平均值或加权平均）
        total_adjustment = sum([adj['adjustment_kcal'] for adj in adjustments]) / len(adjustments)
        
        # 4. 应用调整（带限制）
        new_kcal = current_recommendation.recommended_kcal + total_adjustment
        bmr = CalorieCalculatorService.get_user_bmr(user)
        
        # 安全限制: 不低于BMR的1.1倍
        min_kcal = bmr * 1.1
        new_kcal = max(new_kcal, min_kcal)
        
        # 5. 重新计算宏量营养素
        new_recommendation = self.recalculate_macros(user, new_kcal)
        
        # 6. 记录调整历史
        self.log_adjustment(db, user.id, current_recommendation, new_recommendation, adjustments)
        
        return new_recommendation
```

### 5.3 调整历史记录

**需要新增数据表**: `recommendation_adjustments`

```sql
CREATE TABLE IF NOT EXISTS `recommendation_adjustments` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `user_id` INT NOT NULL,
    `adjustment_date` DATE NOT NULL,
    `previous_kcal` DECIMAL(8, 2),
    `new_kcal` DECIMAL(8, 2),
    `adjustment_reason` TEXT,
    `trigger_factors` JSON,  -- 存储触发调整的因素
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_date (`user_id`, `adjustment_date`)
) COMMENT='推荐调整历史记录表';
```

---

## 人群差异化策略

### 6.1 性别差异

#### 6.1.1 男性 vs 女性

| 维度 | 男性 | 女性 |
|------|------|------|
| **BMR基础** | 通常较高 | 通常较低 |
| **减脂期蛋白质** | 1.6-2.0 g/kg | 1.8-2.2 g/kg (更高) |
| **脂肪最低需求** | 20%总热量 | 25%总热量 (激素平衡) |
| **体态重组潜力** | 较高 | 中等 (需考虑周期) |

**实现**:
```python
def apply_gender_adjustments(
    user: User, 
    base_recommendation: CalorieRecommendation
) -> CalorieRecommendation:
    """
    应用性别相关的调整
    """
    if user.gender == 'female':
        # 女性减脂期需要更高蛋白质
        if user.goal == 'lose_weight':
            protein_g = max(
                base_recommendation.protein_g,
                float(user.weight_kg) * 1.8  # 至少1.8g/kg
            )
            # 调整其他宏量营养素
            # ...
    
    return adjusted_recommendation
```

### 6.2 活动水平差异

#### 6.2.1 久坐人群 vs 高活动人群

**久坐人群 (sedentary, lightly_active)**:
- 热量需求: 较低
- 蛋白质: 可适当降低至1.4-1.6 g/kg (如果目标不是增肌)
- 碳水: 适度降低，避免过多能量堆积

**高活动人群 (very_active, extra_active)**:
- 热量需求: 较高
- 蛋白质: 建议1.8-2.2 g/kg (高活动量需要更多修复)
- 碳水: 提高比例，支持训练表现
- 可考虑训练日/休息日差异化

**实现**:
```python
def apply_activity_adjustments(
    user: User,
    base_recommendation: CalorieRecommendation
) -> CalorieRecommendation:
    """
    根据活动水平调整
    """
    if user.activity_level in ['very_active', 'extra_active']:
        # 高活动人群: 提高碳水比例
        carb_percentage = 0.45  # 从标准40%提高到45%
        # 重新分配宏量营养素
        # ...
    elif user.activity_level == 'sedentary':
        # 久坐人群: 降低碳水，提高蛋白质和脂肪
        carb_percentage = 0.35
        # ...
    
    return adjusted_recommendation
```

### 6.3 目标阶段差异

#### 6.3.1 减脂期 vs 增肌期

| 维度 | 减脂期 | 增肌期 |
|------|--------|--------|
| **热量** | TDEE的75-90% | TDEE的105-115% |
| **蛋白质** | 1.8-2.2 g/kg (高) | 1.8-2.2 g/kg (高) |
| **脂肪** | 25-30% (增加饱腹感) | 20-25% (为碳水留空间) |
| **碳水** | 35-45% (适度) | 40-50% (支持训练) |
| **重点** | 保持肌肉，控制热量 | 支持训练，适度盈余 |

#### 6.3.2 体态重组特殊策略

**适用人群**: 体脂率15-25%，有一定训练基础

**策略要点**:
1. **热量**: 接近维持或轻微赤字(5%)
2. **蛋白质**: 最高需求(2.0-2.4 g/kg)
3. **训练配合**: 必须配合规律力量训练
4. **周期化**: 可考虑微周期调整（训练日略高，休息日略低）

---

## 科学依据

### 7.1 蛋白质摄入共识

**主要研究结论**:
- **增肌**: 1.6-2.2 g/kg体重是有效范围，超过2.2 g/kg收益递减
- **减脂**: 高蛋白(1.8-2.2 g/kg)有助于保持肌肉量和增加饱腹感
- **体态重组**: 需要最高蛋白质摄入(2.0-2.4 g/kg)

**参考来源**:
- International Society of Sports Nutrition (ISSN) Position Stand
- Journal of the International Society of Sports Nutrition
- 多项meta-analysis研究支持1.6-2.2 g/kg范围

### 7.2 热量赤字/盈余建议

**减脂**:
- 安全范围: 10-25% TDEE赤字
- 超过25%可能影响代谢和肌肉量
- 建议每周体重下降0.5-1kg

**增肌**:
- 自然增肌需要5-15%热量盈余
- 超过15%可能导致过多脂肪增长
- 新手可接受更高盈余，有经验者建议保守

### 7.3 宏量营养素比例

**脂肪最低需求**: 15-20%总热量（保证必需脂肪酸和脂溶性维生素）

**碳水作用**: 
- 支持训练表现
- 补充肌糖原
- 训练日需求更高

### 7.4 进一步阅读方向

1. **运动营养学基础**
   - "Sports Nutrition: A Practice Manual for Professionals" (Academy of Nutrition and Dietetics)
   - ISSN Position Stands系列

2. **蛋白质研究**
   - "Protein Requirements for Muscle Mass Accretion"相关研究
   - 蛋白质时机和分布的研究

3. **体态重组**
   - "Body Recomposition"相关文献
   - 同时增肌减脂的可行性研究

4. **女性运动营养**
   - 月经周期对代谢的影响
   - 女性特殊营养需求

5. **动态调整算法**
   - 个性化营养推荐系统
   - 基于反馈的推荐优化

---

## 实现方案

### 8.1 需要修改的文件

#### 8.1.1 数据库模型

**新增文件**: `backend/app/models/body_metrics.py`
```python
class BodyMetrics(Base):
    """
    用户身体指标历史记录表
    """
    __tablename__ = "body_metrics"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    record_date = Column(Date, nullable=False)
    weight_kg = Column(DECIMAL(5, 2))
    body_fat_pct = Column(DECIMAL(4, 2))  # 体脂率
    muscle_mass_kg = Column(DECIMAL(5, 2))  # 肌肉量（可选）
    notes = Column(Text)  # 备注
    
    created_at = Column(TIMESTAMP, server_default=text("CURRENT_TIMESTAMP"))
```

**修改文件**: `backend/app/models/user.py`
- 添加可选字段: `body_fat_pct`, `training_experience` (beginner/intermediate/advanced)
- 扩展goal枚举: 添加 `'body_recomposition'`

**新增文件**: `backend/app/models/recommendation_history.py`
```python
class RecommendationHistory(Base):
    """
    推荐调整历史记录
    """
    __tablename__ = "recommendation_adjustments"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    adjustment_date = Column(Date, nullable=False)
    previous_kcal = Column(DECIMAL(8, 2))
    new_kcal = Column(DECIMAL(8, 2))
    previous_protein_g = Column(DECIMAL(6, 2))
    new_protein_g = Column(DECIMAL(6, 2))
    adjustment_reason = Column(Text)
    trigger_factors = Column(JSON)  # 触发因素
    
    created_at = Column(TIMESTAMP, server_default=text("CURRENT_TIMESTAMP"))
```

#### 8.1.2 服务层

**重构文件**: `backend/app/services/recommendation_service.py`
- 重构为支持热量区间
- 实现新的宏量营养素分配逻辑
- 添加人群差异化处理

**新增文件**: `backend/app/services/dynamic_adjustment_service.py`
- 实现动态调整引擎
- 体重变化分析
- 体脂率变化分析
- 执行情况分析
- 综合调整决策

**新增文件**: `backend/app/services/calorie_range_calculator.py`
- 热量区间计算
- 不同目标的区间策略

**新增文件**: `backend/app/services/macro_calculator.py`
- 蛋白质需求计算
- 脂肪需求计算
- 碳水需求计算（剩余热量原则）

#### 8.1.3 Schema层

**修改文件**: `backend/app/schemas/log.py`
- 扩展 `CalorieRecommendation`，添加区间字段:
  ```python
  class CalorieRecommendation(BaseModel):
      goal: str
      recommended_kcal: float
      min_kcal: float  # 新增
      max_kcal: float  # 新增
      protein_g: float
      protein_min_g: float  # 新增
      protein_max_g: float  # 新增
      fat_g: float
      fat_min_g: float  # 新增
      fat_max_g: float  # 新增
      carbs_g: float
      carbs_min_g: float  # 新增
      carbs_max_g: float  # 新增
      range_description: str  # 新增：区间说明
  ```

**新增文件**: `backend/app/schemas/body_metrics.py`
- BodyMetrics创建和响应Schema

**新增文件**: `backend/app/schemas/recommendation_history.py`
- RecommendationHistory Schema

#### 8.1.4 API端点

**修改文件**: `backend/app/api/endpoints/recommendations.py`
- 更新推荐端点，返回区间数据
- 添加手动触发调整的端点（可选）

**新增文件**: `backend/app/api/endpoints/body_metrics.py`
- POST `/body-metrics/`: 记录身体指标
- GET `/body-metrics/`: 获取历史记录
- GET `/body-metrics/trends`: 获取趋势分析

#### 8.1.5 CRUD层

**新增文件**: `backend/app/crud/crud_body_metrics.py`
- BodyMetrics的CRUD操作

**新增文件**: `backend/app/crud/crud_recommendation_history.py`
- RecommendationHistory的CRUD操作

### 8.2 数据库迁移

**新增SQL脚本**: `database/migrations/add_dynamic_recommendation_tables.sql`

```sql
-- 1. 添加用户表新字段
ALTER TABLE `users` 
ADD COLUMN `body_fat_pct` DECIMAL(4, 2) DEFAULT NULL COMMENT '体脂率' AFTER `weight_kg`,
ADD COLUMN `training_experience` ENUM('beginner', 'intermediate', 'advanced') DEFAULT 'beginner' COMMENT '训练经验' AFTER `goal`;

-- 2. 扩展goal枚举（MySQL 5.7+需要重建表，这里简化说明）
-- 实际需要: ALTER TABLE users MODIFY COLUMN goal ENUM(...) 包含 'body_recomposition'

-- 3. 创建身体指标记录表
CREATE TABLE IF NOT EXISTS `body_metrics` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `user_id` INT NOT NULL,
    `record_date` DATE NOT NULL,
    `weight_kg` DECIMAL(5, 2),
    `body_fat_pct` DECIMAL(4, 2),
    `muscle_mass_kg` DECIMAL(5, 2),
    `notes` TEXT,
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_date (`user_id`, `record_date`)
) COMMENT='用户身体指标历史记录表';

-- 4. 创建推荐调整历史表
CREATE TABLE IF NOT EXISTS `recommendation_adjustments` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `user_id` INT NOT NULL,
    `adjustment_date` DATE NOT NULL,
    `previous_kcal` DECIMAL(8, 2),
    `new_kcal` DECIMAL(8, 2),
    `previous_protein_g` DECIMAL(6, 2),
    `new_protein_g` DECIMAL(6, 2),
    `previous_fat_g` DECIMAL(6, 2),
    `new_fat_g` DECIMAL(6, 2),
    `previous_carbs_g` DECIMAL(6, 2),
    `new_carbs_g` DECIMAL(6, 2),
    `adjustment_reason` TEXT,
    `trigger_factors` JSON,
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_date (`user_id`, `adjustment_date`)
) COMMENT='推荐调整历史记录表';
```

### 8.3 实现优先级

**Phase 1: 基础功能**
1. ✅ BMR/TDEE计算（已实现）
2. 热量区间计算
3. 新的宏量营养素分配逻辑
4. 基础的人群差异化（性别、活动水平）

**Phase 2: 动态调整**
1. 体重历史记录功能
2. 基于体重的自动调整
3. 基于执行情况的调整
4. 调整历史记录

**Phase 3: 高级功能**
1. 体脂率记录和分析
2. 基于体脂率的调整
3. 训练表现分析
4. 体态重组目标支持

**Phase 4: 优化**
1. 周期化营养策略（训练日/休息日）
2. 女性月经周期考虑
3. 更精细的个性化算法

### 8.4 测试建议

1. **单元测试**: 每个计算函数的边界情况
2. **集成测试**: 完整的推荐流程
3. **数据验证**: 确保推荐值在合理范围内
4. **用户测试**: 收集实际使用反馈

---

## 总结

本设计文档提供了一个完整的动态营养推荐系统框架，从基础计算到高级个性化调整。系统设计遵循运动营养学科学共识，同时考虑实际产品落地的可行性。

**核心创新点**:
1. **热量区间**而非单一值，提供灵活性
2. **动态调整机制**，基于实际数据自动优化
3. **人群差异化**，考虑性别、活动水平、训练经验
4. **科学依据**，所有推荐都有研究支持

**下一步行动**:
1. 按照Phase 1优先级开始实现
2. 逐步添加数据收集功能（体重、体脂率）
3. 持续优化调整算法
4. 收集用户反馈，迭代改进

---

**文档版本**: v1.0  
**最后更新**: 2026-01-23  
**作者**: AI Assistant (基于用户需求设计)
